---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/common/Navbar.astro";
import Footer from "../components/common/Footer.astro";
import ContactSection from "../components/AccueilSections/ContactSection.astro";
import heroDesktop from "../assets/savoir-faire/hero-background.png";
import heroMobile from "../assets/savoir-faire/hero-mobile.png";

const steps = [
    {
        number: "01",
        title: "Écoute et Analyse des besoins",
        text: `Depuis notre atelier de 700m² situé à TIGERY aux portes de Paris nous supervisons l'ensemble des dossiers client. Chaque projet est unique et nécessite des prouesses de modélisation.

La phase d'écoute est donc extrêmement importante pour réussir un flight aligné avec vos enjeux métiers. Et la connaissance de vos process et le dialogue avec vos équipes opérationnelles sont importants pour définir tous les points fonctionnels et technique de votre flight case.

Le design aussi est un facteur clé dans la réussite d'un flight case et nous l'intégrons dans nos réalisations. 

En plus d'être fonctionnel, votre flight mérite d'être élégant.`,
    },
    {
        number: "02",
        title: "Modélisation et Solution technique",
        text: `Depuis un plan fourni, un modèle à répliquer ou alors partir d'une feuille blanche, notre bureau d'étude exploite et programme un Nesting de production sur nos système numérique.

Le succès de la réalisation d'un flight case se mesure par plusieurs critères dont :
• la cohérence des agencements qu'il propose
• le respect d'un standard de votre parc existant
• le confort de manipulation par vos opérateurs
• l'optimisation de son encombrement dans votre stock, lors des transports, en situation d'usage`,
    },
    {
        number: "03",
        title: "Usinage et CN",
        text: `Notre équipement numérique est un élément de productivité qui apporte précision et rapidité de traitement de nos débits. Ainsi les métriques de notre fabrication sont constantes, du prototype à la série.

Néanmoins nous restons très attaché à l'artisanat, et la précision du geste de nos opérateurs est encore très présent dans notre process de fabrication.`,
    },
    {
        number: "04",
        title: "Assemblage",
        text: `L'assemblage du projet est confié à l'un de nos collaborateur qui en assure le montage tout en étant garant du contrôle qualité.
Le bois, l'aluminium, le PVC et --les accessoires-- sont tous supervisés avant assemblage pour garantir une durabilité maximale.`,
    },
    {
        number: "05",
        title: "Capitonnage et Finitions mousses",
        text: `Le capitonnage est aussi une étape clé qui garanti le maintien total de votre item dans toutes les configurations possibles de transport, neutralisant les vibrations et les chocs.

Les mousses haute densité sont utilisées en fonction des contraintes spécifiques de chaque équipement protégé.`,
    },
    {
        number: "06",
        title: "Conditionnement et livraison",
        text: `Notre process de conditionnement s'appuie sur les standards du transport, afin de garantir un état irréprochable à nos livraisons.
Chaque flight case est inspecté minutieusement avant d'être expédié vers votre site ou vos événements.`,
    },
];
---

<Layout title="Notre expertise - KDMS">
    <Navbar theme="dark" />

    <main class="bg-black text-white">
        <section
            class="relative min-h-[70vh] md:min-h-screen flex items-center justify-center pt-20 md:pt-24 overflow-hidden"
        >
            <div class="text-center w-full max-w-5xl mx-auto px-4 sm:px-6 z-10">
                <h1
                    class="text-3xl sm:text-4xl md:text-6xl lg:text-8xl font-bold mb-3 md:mb-4 tracking-tight"
                >
                    NOTRE EXPERTISE
                </h1>
                <p
                    class="text-base sm:text-lg md:text-2xl lg:text-3xl text-white/70 font-light"
                >
                    L'EXCELLENCE TECHNIQUE AU SERVICE DE VOS PROJETS.<br
                        class="hidden md:block"
                    />
                    DE LA CONCEPTION À LA FABRICATION.
                </p>
            </div>

            <div
                class="absolute right-0 top-1/2 -translate-y-1/2 z-0 h-[80vh] w-auto opacity-25 hidden md:block"
            >
                <img
                    src={heroDesktop.src}
                    alt="Flight case KDMS"
                    class="h-full w-auto object-contain"
                    loading="eager"
                />
            </div>

            <div
                class="absolute right-0 top-1/2 -translate-y-1/2 z-0 h-[60vh] w-auto opacity-30 md:hidden"
            >
                <img
                    src={heroMobile.src}
                    alt="Flight case KDMS"
                    class="h-full w-auto object-contain"
                    loading="eager"
                />
            </div>

            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 animate-bounce">
                <button id="scroll-to-process" class="flex flex-col items-center gap-2 cursor-pointer hover:opacity-100 transition-opacity bg-transparent border-none">
                    <span class="text-white/40 text-xs uppercase tracking-widest font-medium">Découvrir</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white/40">
                        <path d="M7 13l5 5 5-5"></path>
                        <path d="M7 6l5 5 5-5"></path>
                    </svg>
                </button>
            </div>
        </section>

        <section id="processus-section" class="relative py-16 md:py-24 px-4 sm:px-6">
            <div class="text-center mb-16 md:mb-24">
                <h2
                    class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold mb-4"
                >
                    Notre <span class="text-[#4A5D23]">processus</span> de fabrication
                </h2>
                <p class="text-white/60 text-base md:text-lg max-w-2xl mx-auto">
                    De l'idée à la livraison, découvrez les 6 étapes clés qui
                    garantissent l'excellence de nos flight cases.
                </p>
            </div>

            <div id="timeline-container" class="max-w-6xl mx-auto relative">
                <div
                    class="hidden md:block absolute left-1/2 -translate-x-1/2 top-0 bottom-0 w-0.5 bg-white/10"
                >
                </div>
                <div
                    id="timeline-progress"
                    class="hidden md:block absolute left-1/2 -translate-x-1/2 top-0 w-1 bg-gradient-to-b from-[#4A5D23] to-[#7FB255] rounded-full shadow-[0_0_15px_rgba(74,93,35,0.6)]"
                    style="height: 0%;"
                >
                </div>

                <div
                    class="md:hidden absolute left-4 sm:left-8 top-0 bottom-0 w-0.5 bg-white/10"
                >
                </div>
                <div
                    id="timeline-progress-mobile"
                    class="md:hidden absolute left-4 sm:left-8 top-0 w-1 bg-gradient-to-b from-[#4A5D23] to-[#7FB255] rounded-full shadow-[0_0_10px_rgba(74,93,35,0.6)]"
                    style="height: 0%;"
                >
                </div>

                {
                    steps.map((step, index) => (
                        <div
                            class={`timeline-step relative flex items-start gap-4 sm:gap-6 md:gap-0 mb-16 md:mb-24 last:mb-0 ${index % 2 === 0 ? "md:flex-row" : "md:flex-row-reverse"}`}
                            data-step={index}
                        >
                            <div class="md:hidden flex-shrink-0 relative z-10">
                                <div class="w-8 sm:w-12 h-8 sm:h-12 rounded-full bg-[#4A5D23] flex items-center justify-center border-4 border-black shadow-[0_0_20px_rgba(74,93,35,0.5)]">
                                    <span class="text-white font-bold text-xs sm:text-sm">
                                        {step.number}
                                    </span>
                                </div>
                            </div>

                            <div
                                class={`hidden md:block md:w-1/2 ${index % 2 === 0 ? "md:pr-16 md:text-right" : "md:pl-16 md:text-left"}`}
                            >
                                {index % 2 === 0 ? (
                                    <div class="step-content">
                                        <span class="inline-block text-[#4A5D23] text-sm font-bold tracking-widest mb-2">
                                            ÉTAPE {step.number}
                                        </span>
                                        <h3 class="text-2xl lg:text-3xl font-bold text-white mb-4">
                                            {step.title}
                                        </h3>
                                        <p class="text-white/70 leading-relaxed whitespace-pre-line">
                                            {step.text}
                                        </p>
                                    </div>
                                ) : (
                                    <div class="step-image aspect-video bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden shadow-2xl">
                                        <div class="w-full h-full flex items-center justify-center text-white/10 text-8xl font-black">
                                            {step.number}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div class="hidden md:flex absolute left-1/2 -translate-x-1/2 z-10">
                                <div class="timeline-dot w-14 h-14 rounded-full bg-[#4A5D23] flex items-center justify-center border-4 border-black shadow-[0_0_30px_rgba(74,93,35,0.4)] transition-all duration-500">
                                    <span class="text-white font-bold text-lg">
                                        {step.number}
                                    </span>
                                </div>
                            </div>

                            <div
                                class={`hidden md:block md:w-1/2 ${index % 2 === 0 ? "md:pl-16 md:text-left" : "md:pr-16 md:text-right"}`}
                            >
                                {index % 2 === 0 ? (
                                    <div class="step-image aspect-video bg-[#1a1a1a] rounded-xl border border-white/10 overflow-hidden shadow-2xl">
                                        <div class="w-full h-full flex items-center justify-center text-white/10 text-8xl font-black">
                                            {step.number}
                                        </div>
                                    </div>
                                ) : (
                                    <div class="step-content">
                                        <span class="inline-block text-[#4A5D23] text-sm font-bold tracking-widest mb-2">
                                            ÉTAPE {step.number}
                                        </span>
                                        <h3 class="text-2xl lg:text-3xl font-bold text-white mb-4">
                                            {step.title}
                                        </h3>
                                        <p class="text-white/70 leading-relaxed whitespace-pre-line">
                                            {step.text}
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div class="md:hidden flex-1">
                                <span class="inline-block text-[#4A5D23] text-xs font-bold tracking-widest mb-1">
                                    ÉTAPE {step.number}
                                </span>
                                <h3 class="text-xl sm:text-2xl font-bold text-white mb-3">
                                    {step.title}
                                </h3>
                                <div class="aspect-video bg-[#1a1a1a] rounded-lg border border-white/10 overflow-hidden shadow-xl mb-4">
                                    <div class="w-full h-full flex items-center justify-center text-white/10 text-5xl font-black">
                                        {step.number}
                                    </div>
                                </div>
                                <p class="text-white/70 text-sm sm:text-base leading-relaxed whitespace-pre-line">
                                    {step.text}
                                </p>
                            </div>
                        </div>
                    ))
                }
            </div>
        </section>

        <div
            id="progress-indicator"
            class="fixed bottom-6 right-6 z-50 hidden md:flex items-center gap-3 bg-black/80 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 opacity-0 transition-opacity duration-300"
        >
            <div class="w-24 h-1.5 bg-white/20 rounded-full overflow-hidden">
                <div
                    id="progress-bar"
                    class="h-full bg-[#4A5D23] rounded-full transition-all duration-300"
                    style="width: 0%"
                >
                </div>
            </div>
            <span id="progress-text" class="text-white/60 text-sm font-medium"
                >1/6</span
            >
        </div>

        <ContactSection />
        <Footer />
    </main>
</Layout>

<style>
    .timeline-step {
        opacity: 0;
        transform: translateY(40px);
        transition:
            opacity 0.6s ease-out,
            transform 0.6s ease-out;
    }

    .timeline-step.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .timeline-dot {
        transform: scale(0.8);
        transition:
            transform 0.4s ease-out,
            box-shadow 0.4s ease-out;
    }

    .timeline-step.visible .timeline-dot {
        transform: scale(1);
    }

    .timeline-step.active .timeline-dot {
        box-shadow: 0 0 40px rgba(74, 93, 35, 0.6);
    }

    .step-content,
    .step-image {
        opacity: 0;
        transform: translateX(20px);
        transition:
            opacity 0.6s ease-out 0.2s,
            transform 0.6s ease-out 0.2s;
    }

    .timeline-step:nth-child(odd) .step-content {
        transform: translateX(-20px);
    }

    .timeline-step.visible .step-content,
    .timeline-step.visible .step-image {
        opacity: 1;
        transform: translateX(0);
    }

    #timeline-progress,
    #timeline-progress-mobile {
        transition: height 0.1s ease-out;
    }
</style>

<script>
    const timelineSteps = document.querySelectorAll(".timeline-step");
    const progressIndicator = document.getElementById("progress-indicator");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");
    const timelineContainer = document.getElementById("timeline-container");
    const timelineProgress = document.getElementById("timeline-progress");
    const timelineProgressMobile = document.getElementById(
        "timeline-progress-mobile",
    );

    // Fonction pour mettre à jour la ligne de progression
    function updateTimelineProgress() {
        if (!timelineContainer) return;

        const containerRect = timelineContainer.getBoundingClientRect();
        const containerTop = containerRect.top;
        const containerHeight = containerRect.height;
        const windowHeight = window.innerHeight;
        const scrollTriggerPoint = windowHeight * 0.5; // Point de déclenchement au milieu de l'écran

        // Calcul de la progression
        let progress = 0;

        if (containerTop < scrollTriggerPoint) {
            const scrolled = scrollTriggerPoint - containerTop;
            progress = Math.min(Math.max(scrolled / containerHeight, 0), 1);
        }

        const progressHeight = progress * 100;

        if (timelineProgress) {
            timelineProgress.style.height = `${progressHeight}%`;
        }
        if (timelineProgressMobile) {
            timelineProgressMobile.style.height = `${progressHeight}%`;
        }
    }

    // Écouter le scroll
    window.addEventListener("scroll", updateTimelineProgress, {
        passive: true,
    });
    updateTimelineProgress(); // Initial call

    const observerOptions = {
        root: null,
        rootMargin: "-10% 0px -10% 0px",
        threshold: 0.2,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add("visible");
            }
        });
    }, observerOptions);

    timelineSteps.forEach((step) => {
        observer.observe(step);
    });

    let currentStep = 0;
    const totalSteps = timelineSteps.length;

    const progressObserverOptions = {
        root: null,
        rootMargin: "-50% 0px -50% 0px",
        threshold: 0,
    };

    const progressObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            const stepIndex = parseInt(
                entry.target.getAttribute("data-step") || "0",
            );

            if (entry.isIntersecting) {
                currentStep = stepIndex + 1;
                updateProgress();

                // Add active class
                timelineSteps.forEach((s, i) => {
                    if (i === stepIndex) {
                        s.classList.add("active");
                    } else {
                        s.classList.remove("active");
                    }
                });
            }
        });
    }, progressObserverOptions);

    timelineSteps.forEach((step) => {
        progressObserver.observe(step);
    });

    function updateProgress() {
        if (progressBar && progressText) {
            const percentage = (currentStep / totalSteps) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${currentStep}/${totalSteps}`;
        }
    }

    const timelineSection = document.querySelector("section:nth-of-type(2)");

    if (timelineSection && progressIndicator) {
        const sectionObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        progressIndicator.classList.remove("opacity-0");
                        progressIndicator.classList.add("opacity-100");
                    } else {
                        progressIndicator.classList.add("opacity-0");
                        progressIndicator.classList.remove("opacity-100");
                    }
                });
            },
            { threshold: 0.1 },
        );

        sectionObserver.observe(timelineSection);
    }

    // Scroll dynamique vers la section processus
    const scrollBtn = document.getElementById('scroll-to-process');
    const processSection = document.getElementById('processus-section');
    
    if (scrollBtn && processSection) {
        scrollBtn.addEventListener('click', () => {
            const navbar = document.querySelector('nav');
            const navHeight = navbar ? navbar.offsetHeight : 0;
            const sectionTop = processSection.getBoundingClientRect().top + window.scrollY;
            
            window.scrollTo({
                top: sectionTop - navHeight,
                behavior: 'smooth'
            });
        });
    }
</script>
