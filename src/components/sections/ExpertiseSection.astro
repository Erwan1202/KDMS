---
import { Image } from "astro:assets";

const expertiseItems = [
    {
        title: "Notre histoire",
        text: "Depuis 1997 nous sommes bien plus qu'un fournisseur pour les professionnels de l'industrie, de l'événementiel et du spectacle vivant. Nous sommes le partenaire de tous vos projets de conditionnement.",
    },
    {
        title: "2 poles de production",
        text: "Situées à Tigery (91) sud IDF, et à Viana Do Castelo au Portugal, nous vous offrons une solide présence logistique et commerciale sur toute l'Europe.",
    },
    {
        title: "Gestion des processus de bout en bout",
        text: "Au carrefour de l'artisanat et de l'industrie nous avons adapté nos gestes et outils de production pour défendre notre compétitivité, en supervisant notre chaîne de production de bout en bout.",
    },
    {
        title: "Une société a taille humaine",
        text: "Tous nos collaborateurs sont sensibles aux valeurs que nous défendons : le conseil, la proximité, la flexibilité, et enfin l'engagement de service.",
    },
];
---

<div
    id="expertise-wrapper"
    class="expertise-section w-full min-h-screen flex flex-col justify-center py-12 px-4 sm:px-6 lg:px-8 bg-[#1A1A1A]"
>
    <div
        class="expertise-content w-full max-w-7xl mx-auto flex flex-col items-center text-center mb-8 md:mb-12"
    >
        <h2
            class="expertise-title w-full text-3xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold mb-4 mt-8 tracking-tight text-center mx-auto text-white"
            style="text-wrap: balance;"
        >
            <span class="text-[#4A5D23]">20 ans</span> d'expertise
        </h2>
        <p
            class="text-white/80 text-base sm:text-lg md:text-xl lg:text-2xl font-light leading-relaxed max-w-3xl mx-auto"
            style="text-wrap: balance;"
        >
            MADE IN FRANCE
        </p>
    </div>

    <div class="expertise-content w-full overflow-hidden">
        <div
            class="hidden lg:flex gap-3 lg:gap-4 xl:gap-5 overflow-hidden pb-4 px-4 lg:px-8 xl:px-12 items-center justify-center"
        >
            {
                expertiseItems.map((item) => (
                    <div
                        class="relative expertise-image bg-[#262626] w-[100px] lg:w-[120px] xl:w-[140px] min-w-[100px] lg:min-w-[120px] xl:min-w-[140px] h-[350px] lg:h-[400px] xl:h-[450px] rounded-lg border border-[#4A5D23]/30 flex-shrink-0 transition-all duration-500 hover:w-[400px] lg:hover:w-[450px] xl:hover:w-[500px] hover:border-[#7FB255] hover:shadow-[0_0_30px_rgba(92,143,58,0.2)] cursor-pointer grayscale hover:grayscale-0 overflow-hidden"
                        data-title={item.title}
                        data-text={item.text}
                    >
                        {item.image && (
                            <Image
                                src={item.image}
                                alt={item.title}
                                class="w-full h-full object-cover"
                            />
                        )}
                    </div>
                ))
            }

            <div
                class="pl-4 lg:pl-6 xl:pl-8 flex-shrink-0 flex flex-col items-center justify-center gap-4 min-w-[250px] lg:min-w-[280px] xl:min-w-[320px] max-w-[350px] lg:max-w-[400px] xl:max-w-[450px]"
            >
                <h3
                    id="expertise-title"
                    class="text-xl lg:text-2xl xl:text-3xl font-bold text-white text-center leading-snug transition-opacity duration-300 flex items-center justify-center tracking-tight"
                >
                    La mobilité de votre expertise est notre métier
                </h3>
                <p
                    id="expertise-text"
                    class="text-base lg:text-lg xl:text-xl text-[#B8B8B8] text-justify transition-all duration-300 font-medium leading-relaxed hidden"
                >
                </p>

                <a
                    href="/expertise"
                    class="mt-6 xl:mt-8 group relative inline-flex items-center justify-center px-8 lg:px-12 xl:px-16 py-3 xl:py-4 overflow-hidden rounded-full bg-[#E07A1F] transition-all duration-300 hover:bg-[#C86618] hover:shadow-[0_8px_30px_rgba(224,122,31,0.4)] whitespace-nowrap no-underline"
                >
                    <span
                        class="relative text-white font-medium text-sm tracking-[0.2em] uppercase transition-colors"
                        >Découvrir</span
                    >
                </a>
            </div>
        </div>

        <div
            class="flex flex-col gap-8 sm:gap-10 md:gap-12 px-4 sm:px-6 md:px-8 lg:hidden text-white pb-12 md:pb-20"
        >
            {
                expertiseItems.map((item, index) => (
                    <div class="flex flex-col gap-4 sm:gap-6 items-center max-w-3xl mx-auto w-full">
                        <div class="relative w-full h-48 sm:h-56 md:h-64 lg:h-72 rounded-lg border border-[#4A5D23]/30 overflow-hidden bg-[#262626] shadow-[inset_0_0_20px_rgba(255,255,255,0.1)]">
                            {item.image && (
                                <Image
                                    src={item.image}
                                    alt={item.title}
                                    class="w-full h-full object-cover grayscale"
                                />
                            )}
                        </div>
                        <div class="text-left sm:text-justify w-full">
                            <h3 class="text-xl sm:text-2xl md:text-3xl font-bold mb-2 sm:mb-3 tracking-tight">
                                {item.title}
                            </h3>
                            <p class="text-base sm:text-lg text-[#B8B8B8] font-light leading-relaxed">
                                {item.text}
                            </p>
                        </div>
                        {index === expertiseItems.length - 1 && (
                            <div class="flex justify-center mt-4">
                                <a
                                    href="/expertise"
                                    class="group relative inline-flex items-center justify-center px-8 sm:px-10 md:px-12 py-3 overflow-hidden rounded-full bg-[#E07A1F] transition-all duration-300 hover:bg-[#C86618] hover:shadow-[0_8px_30px_rgba(224,122,31,0.4)] whitespace-nowrap no-underline"
                                >
                                    <span class="relative text-white font-bold text-base sm:text-lg tracking-wider transition-colors">
                                        Découvrir
                                    </span>
                                </a>
                            </div>
                        )}
                    </div>
                ))
            }
        </div>
    </div>
</div>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const expertiseImages = document.querySelectorAll(".expertise-image");
    const expertiseTitle = document.getElementById("expertise-title");
    const expertiseText = document.getElementById("expertise-text");

    const defaultTitle = "La mobilité de votre expertise est notre métier";
    const conclusionTitle =
        "C'est avec cette dynamique que nous souhaitons continuer à développer nos activités, en restant flexible et pouvoir rapidement nous réinventer.";

    let currentIndex = -1;
    let autoRotateInterval: ReturnType<typeof setInterval> | null = null;
    let isHovering = false;

    function expandImage(index: number) {
        expertiseImages.forEach((img, i) => {
            const element = img as HTMLElement;
            const screenWidth = window.innerWidth;
            let expandedWidth = "500px";
            let collapsedWidth = "140px";

            if (screenWidth < 1536) {
                expandedWidth = "450px";
                collapsedWidth = "120px";
            }
            if (screenWidth < 1280) {
                expandedWidth = "400px";
                collapsedWidth = "100px";
            }

            if (i === index) {
                element.style.width = expandedWidth;
                element.style.boxShadow =
                    "inset 0 0 20px rgba(255,255,255,0.1), 0 0 15px 5px rgba(255,255,255,0.25)";
            } else {
                element.style.width = collapsedWidth;
                element.style.boxShadow = "none";
            }
        });
    }

    function collapseAllImages() {
        const screenWidth = window.innerWidth;
        let collapsedWidth = "140px";

        if (screenWidth < 1536) collapsedWidth = "120px";
        if (screenWidth < 1280) collapsedWidth = "100px";

        expertiseImages.forEach((img) => {
            const element = img as HTMLElement;
            element.style.width = collapsedWidth;
            element.style.boxShadow = "none";
        });
    }

    function updateText(title: string, text: string = "") {
        if (expertiseTitle && expertiseText) {
            expertiseTitle.style.opacity = "0";
            expertiseText.style.opacity = "0";
            setTimeout(() => {
                expertiseTitle.innerText = title;
                expertiseTitle.style.opacity = "1";
                if (text) {
                    expertiseText.innerText = text;
                    expertiseText.classList.remove("hidden");
                    expertiseText.style.opacity = "1";
                } else {
                    expertiseText.classList.add("hidden");
                }
            }, 150);
        }
    }

    function autoRotate() {
        if (isHovering) return;

        currentIndex++;

        if (currentIndex < expertiseImages.length) {
            const img = expertiseImages[currentIndex];
            const title = img.getAttribute("data-title") || "";
            const text = img.getAttribute("data-text") || "";
            expandImage(currentIndex);
            updateText(title, text);
        } else if (currentIndex === expertiseImages.length) {
            collapseAllImages();
            updateText(conclusionTitle);
        } else {
            currentIndex = -1;
            collapseAllImages();
            updateText(defaultTitle);
        }
    }

    function startAutoRotate() {
        if (autoRotateInterval) clearInterval(autoRotateInterval);
        autoRotateInterval = setInterval(autoRotate, 7500);
    }

    collapseAllImages();
    startAutoRotate();

    expertiseImages.forEach((img, index) => {
        img.addEventListener("mouseenter", () => {
            isHovering = true;
            const title = img.getAttribute("data-title") || "";
            const text = img.getAttribute("data-text") || "";

            expandImage(index);
            updateText(title, text);
        });

        img.addEventListener("mouseleave", () => {
            isHovering = false;
            if (currentIndex >= 0 && currentIndex < expertiseImages.length) {
                const currentImg = expertiseImages[currentIndex];
                const title = currentImg.getAttribute("data-title") || "";
                const text = currentImg.getAttribute("data-text") || "";
                expandImage(currentIndex);
                updateText(title, text);
            } else if (currentIndex === expertiseImages.length) {
                collapseAllImages();
                updateText(conclusionTitle);
            } else {
                collapseAllImages();
                updateText(defaultTitle);
            }
        });
    });

    const sectionTitle = document.querySelector(".expertise-title");
    const contentBlocks = document.querySelectorAll(".expertise-content");

    if (sectionTitle) {
        gsap.fromTo(
            sectionTitle,
            { y: 60, opacity: 0 },
            {
                y: 0,
                opacity: 1,
                duration: 1,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: sectionTitle,
                    start: "top 85%",
                    toggleActions: "play none none none",
                },
            },
        );
    }

    contentBlocks.forEach((block, index) => {
        gsap.fromTo(
            block,
            { y: 40, opacity: 0 },
            {
                y: 0,
                opacity: 1,
                duration: 0.8,
                delay: index * 0.15,
                ease: "power2.out",
                scrollTrigger: {
                    trigger: block,
                    start: "top 90%",
                    toggleActions: "play none none none",
                },
            },
        );
    });

    gsap.fromTo(
        ".expertise-image",
        { y: 30, opacity: 0, scale: 0.95 },
        {
            y: 0,
            opacity: 1,
            scale: 1,
            duration: 0.6,
            stagger: 0.1,
            ease: "back.out(1.2)",
            scrollTrigger: {
                trigger: ".expertise-image",
                start: "top 85%",
                toggleActions: "play none none none",
            },
        },
    );
</script>
