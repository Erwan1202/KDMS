---
const expertiseItems = [
    {
        title: "Notre histoire",
        text: "Depuis 1997 nous sommes bien plus qu'un fournisseur pour les professionnels de l'industrie, de l'événementiel et du spectacle vivant. Nous sommes le partenaire de tous vos projets de conditionnement.",
    },
    {
        title: "2 poles de production",
        text: "Situées à Tigery (91) sud IDF, et à Viana Do Castelo au Portugal, nous vous offrons une solide présence logistique et commerciale sur toute l'Europe.",
    },
    {
        title: "Gestion des processus de bout en bout",
        text: "Au carrefour de l'artisanat et de l'industrie nous avons adapté nos gestes et outils de production pour défendre notre compétitivité, en supervisant notre chaîne de production de bout en bout.",
    },
    {
        title: "Une société a taille humaine",
        text: "Tous nos collaborateurs sont sensibles aux valeurs que nous défendons : le conseil, la proximité, la flexibilité, et enfin l'engagement de service.",
    },
];
---

<div
    id="expertise-wrapper"
    class="expertise-section w-full min-h-screen flex flex-col justify-center pb-12 px-0 pt-2 bg-[#0E0E0E]"
>
    <div
        class="expertise-content w-full md:max-w-5xl mx-auto flex flex-col items-center text-center mb-12 px-2 md:px-8"
    >
        <h2
            class="expertise-title w-full text-3xl sm:text-5xl md:text-8xl font-bold mb-4 mt-8 md:tracking-tight text-center mx-auto"
            style="text-wrap: balance;"
        >
            20 ans d'expertise
        </h2>
    </div>

    <div class="expertise-content w-full overflow-hidden">
        <div
            class="hidden 2xl:flex gap-5 overflow-hidden pb-4 pl-20 pr-8 items-center"
        >
            {
                expertiseItems.map((item) => (
                    <div
                        class="expertise-image bg-[#1a1a1a] w-[160px] min-w-[160px] h-[55vh] rounded-lg border border-white/20 flex-shrink-0 transition-all duration-500 hover:w-[60vh] hover:shadow-[inset_0_0_20px_rgba(255,255,255,0.1),0_0_15px_5px_rgba(255,255,255,0.25)] cursor-pointer"
                        data-title={item.title}
                        data-text={item.text}
                    />
                ))
            }

            <div
                class="pl-8 flex-shrink-0 flex flex-col items-center justify-center gap-4 min-w-[320px] max-w-[450px]"
            >
                <h4
                    id="expertise-title"
                    class="text-2xl md:text-4xl font-bold text-white text-center leading-snug transition-opacity duration-300 flex items-center justify-center"
                >
                    La mobilité de votre expertise est notre métier
                </h4>
                <p
                    id="expertise-text"
                    class="text-lg md:text-xl text-white/80 text-justify transition-all duration-300 font-light leading-relaxed hidden"
                >
                </p>

                <a
                    href="/savoir-faire"
                    class="mt-4 group relative inline-flex items-center justify-center px-16 py-3 overflow-hidden rounded-full bg-[#525946] border-2 border-[#6b755a] shadow-[0_6px_20px_rgba(82,89,70,0.5)] transition-all duration-300 hover:scale-105 hover:shadow-[0_8px_30px_rgba(82,89,70,0.7)] whitespace-nowrap no-underline"
                >
                    <span
                        class="absolute inset-0 w-full h-full bg-gradient-to-br from-white/20 to-transparent opacity-50"
                    ></span>
                    <span
                        class="relative text-white font-bold text-xl tracking-wider"
                        >Découvrir</span
                    >
                </a>
            </div>
        </div>

        <div class="flex flex-col gap-12 px-8 2xl:hidden text-white pb-20">
            {
                expertiseItems.map((item, index) => (
                    <div class="flex flex-col gap-6 items-center">
                        <div class="w-full md:w-3/4 h-56 md:h-72 rounded-lg border border-white/20 overflow-hidden bg-[#1a1a1a] shadow-[inset_0_0_20px_rgba(255,255,255,0.1)]" />
                        <div class="text-justify">
                            <h4 class="text-3xl font-bold mb-3 tracking-tight">
                                {item.title}
                            </h4>
                            <p class="text-lg text-white/80 font-light leading-relaxed text-justify">
                                {item.text}
                            </p>
                        </div>
                        {index === expertiseItems.length - 1 && (
                            <div class="flex justify-center mt-4">
                                <a
                                    href="/savoir-faire"
                                    class="group relative inline-flex items-center justify-center px-12 py-3 overflow-hidden rounded-full bg-[#525946] border-2 border-[#6b755a] shadow-[0_6px_20px_rgba(82,89,70,0.5)] transition-all duration-300 hover:scale-105 hover:shadow-[0_8px_30px_rgba(82,89,70,0.7)] whitespace-nowrap no-underline"
                                >
                                    <span class="absolute inset-0 w-full h-full bg-gradient-to-br from-white/20 to-transparent opacity-50" />
                                    <span class="relative text-white font-bold text-lg tracking-wider">
                                        Découvrir
                                    </span>
                                </a>
                            </div>
                        )}
                    </div>
                ))
            }
        </div>
    </div>
</div>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    // Expertise carousel logic (no GSAP dependency)
    const expertiseImages = document.querySelectorAll(".expertise-image");
    const expertiseTitle = document.getElementById("expertise-title");
    const expertiseText = document.getElementById("expertise-text");

    const defaultTitle = "La mobilité de votre expertise est notre métier";
    const conclusionTitle =
        "C'est avec cette dynamique que nous souhaitons continuer à développer nos activités, en restant flexible et pouvoir rapidement nous réinventer.";

    let currentIndex = -1;
    let autoRotateInterval: ReturnType<typeof setInterval> | null = null;
    let isHovering = false;

    function expandImage(index: number) {
        expertiseImages.forEach((img, i) => {
            const element = img as HTMLElement;
            if (i === index) {
                element.style.width = "60vh";
                element.style.boxShadow =
                    "inset 0 0 20px rgba(255,255,255,0.1), 0 0 15px 5px rgba(255,255,255,0.25)";
            } else {
                element.style.width = "160px";
                element.style.boxShadow = "none";
            }
        });
    }

    function collapseAllImages() {
        expertiseImages.forEach((img) => {
            const element = img as HTMLElement;
            element.style.width = "160px";
            element.style.boxShadow = "none";
        });
    }

    function updateText(title: string, text: string = "") {
        if (expertiseTitle && expertiseText) {
            expertiseTitle.style.opacity = "0";
            expertiseText.style.opacity = "0";
            setTimeout(() => {
                expertiseTitle.innerText = title;
                expertiseTitle.style.opacity = "1";
                if (text) {
                    expertiseText.innerText = text;
                    expertiseText.classList.remove("hidden");
                    expertiseText.style.opacity = "1";
                } else {
                    expertiseText.classList.add("hidden");
                }
            }, 150);
        }
    }

    function autoRotate() {
        if (isHovering) return;

        currentIndex++;

        if (currentIndex < expertiseImages.length) {
            const img = expertiseImages[currentIndex];
            const title = img.getAttribute("data-title") || "";
            const text = img.getAttribute("data-text") || "";
            expandImage(currentIndex);
            updateText(title, text);
        } else if (currentIndex === expertiseImages.length) {
            collapseAllImages();
            updateText(conclusionTitle);
        } else {
            currentIndex = -1;
            collapseAllImages();
            updateText(defaultTitle);
        }
    }

    function startAutoRotate() {
        if (autoRotateInterval) clearInterval(autoRotateInterval);
        autoRotateInterval = setInterval(autoRotate, 7500);
    }

    collapseAllImages();
    startAutoRotate();

    expertiseImages.forEach((img, index) => {
        img.addEventListener("mouseenter", () => {
            isHovering = true;
            const title = img.getAttribute("data-title") || "";
            const text = img.getAttribute("data-text") || "";

            expandImage(index);
            updateText(title, text);
        });

        img.addEventListener("mouseleave", () => {
            isHovering = false;
            if (currentIndex >= 0 && currentIndex < expertiseImages.length) {
                const currentImg = expertiseImages[currentIndex];
                const title = currentImg.getAttribute("data-title") || "";
                const text = currentImg.getAttribute("data-text") || "";
                expandImage(currentIndex);
                updateText(title, text);
            } else if (currentIndex === expertiseImages.length) {
                collapseAllImages();
                updateText(conclusionTitle);
            } else {
                collapseAllImages();
                updateText(defaultTitle);
            }
        });
    });

    const sectionTitle = document.querySelector(".expertise-title");
    const contentBlocks = document.querySelectorAll(".expertise-content");

    if (sectionTitle) {
        gsap.fromTo(
            sectionTitle,
            { y: 60, opacity: 0 },
            {
                y: 0,
                opacity: 1,
                duration: 1,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: sectionTitle,
                    start: "top 85%",
                    toggleActions: "play none none none",
                },
            },
        );
    }

    contentBlocks.forEach((block, index) => {
        gsap.fromTo(
            block,
            { y: 40, opacity: 0 },
            {
                y: 0,
                opacity: 1,
                duration: 0.8,
                delay: index * 0.15,
                ease: "power2.out",
                scrollTrigger: {
                    trigger: block,
                    start: "top 90%",
                    toggleActions: "play none none none",
                },
            },
        );
    });

    gsap.fromTo(
        ".expertise-image",
        { y: 30, opacity: 0, scale: 0.95 },
        {
            y: 0,
            opacity: 1,
            scale: 1,
            duration: 0.6,
            stagger: 0.1,
            ease: "back.out(1.2)",
            scrollTrigger: {
                trigger: ".expertise-image",
                start: "top 85%",
                toggleActions: "play none none none",
            },
        },
    );
</script>
